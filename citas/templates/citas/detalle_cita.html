{% extends 'citas/base_citas.html' %}

{% block title %}Detalle de Cita - {{ cita.mascota }}{% endblock %}

{% block content %}
<style>
    .cita-detail-container {
        display: grid;
        grid-template-columns: 1fr 350px;
        gap: 30px;
        margin-top: 20px;
    }
    
    .cita-info {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .calendar-sidebar {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        height: fit-content;
        position: sticky;
        top: 20px;
    }
    
    .info-section {
        margin-bottom: 25px;
        padding-bottom: 20px;
        border-bottom: 1px solid #eee;
    }
    
    .info-section h3 {
        color: #2c3e50;
        margin-bottom: 15px;
        font-size: 1.3rem;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .info-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 12px;
        padding: 8px 0;
    }
    
    .info-label {
        font-weight: bold;
        color: #555;
        min-width: 120px;
    }
    
    .info-value {
        color: #333;
        text-align: right;
        flex: 1;
    }
    
    /* ESTILOS DEL CALENDARIO */
    .calendar {
        text-align: center;
    }
    
    .calendar-header {
        background: #27ae60;
        color: white;
        padding: 15px;
        border-radius: 8px 8px 0 0;
        margin: -25px -25px 20px -25px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .calendar-nav {
        background: none;
        border: none;
        color: white;
        font-size: 1.2rem;
        cursor: pointer;
        padding: 5px 10px;
        border-radius: 4px;
        transition: background 0.3s ease;
    }
    
    .calendar-nav:hover {
        background: rgba(255, 255, 255, 0.2);
    }
    
    .calendar-month-year {
        flex: 1;
        text-align: center;
    }
    
    .calendar-month {
        font-size: 1.4rem;
        font-weight: bold;
        margin: 0;
    }
    
    .calendar-year {
        font-size: 1.1rem;
        margin: 5px 0 0 0;
        opacity: 0.9;
    }
    
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
        margin-bottom: 15px;
    }
    
    .calendar-weekday {
        font-weight: bold;
        color: #666;
        padding: 10px 5px;
        font-size: 0.8rem;
        border-bottom: 1px solid #eee;
    }
    
    .calendar-day {
        padding: 12px 5px;
        border-radius: 6px;
        cursor: default;
        transition: all 0.2s ease;
        font-size: 0.9rem;
        position: relative;
    }
    
    .calendar-day.empty {
        background: transparent;
        visibility: hidden;
    }
    
    .calendar-day.normal {
        background: #f8f9fa;
        color: #333;
    }
    
    .calendar-day.other-month {
        background: #f0f0f0;
        color: #999;
    }
    
    .calendar-day.today {
        background: #e3f2fd;
        color: #1976d2;
        font-weight: bold;
    }
    
    .calendar-day.cita-day {
        background: #27ae60;
        color: white;
        font-weight: bold;
        transform: scale(1.05);
        box-shadow: 0 2px 8px rgba(39, 174, 96, 0.4);
    }
    
    .cita-date-highlight {
        background: #e8f5e8;
        padding: 20px;
        border-radius: 8px;
        border-left: 4px solid #27ae60;
        margin-top: 20px;
        text-align: center;
    }
    
    .cita-date-highlight .fecha {
        font-size: 1.3rem;
        font-weight: bold;
        color: #27ae60;
        margin-bottom: 8px;
    }
    
    .cita-date-highlight .hora {
        font-size: 1.1rem;
        color: #666;
        font-weight: bold;
    }

    .btn {
        display: inline-block;
        padding: 10px 20px;
        background: #27ae60;
        color: white;
        text-decoration: none;
        border-radius: 5px;
        border: none;
        cursor: pointer;
        margin: 5px;
        transition: all 0.3s ease;
        font-size: 0.9rem;
    }
    
    .btn:hover {
        background: #219a52;
        transform: translateY(-2px);
    }
    
    .btn-danger {
        background: #e74c3c;
    }
    
    .btn-danger:hover {
        background: #c0392b;
    }

    @media (max-width: 968px) {
        .cita-detail-container {
            grid-template-columns: 1fr;
        }
        
        .calendar-sidebar {
            position: static;
            order: -1;
        }
    }
</style>

<div class="cita-detail-container">
    <!-- Columna izquierda: Información de la cita -->
    <div class="cita-info">
        <h2 style="color: #2c3e50; margin-bottom: 25px; display: flex; align-items: center; gap: 10px;">
             Detalles de la Cita
        </h2>
        
        <div class="info-section">
            <h3> Información de la Mascota</h3>
            <div class="info-row">
                <span class="info-label">Nombre:</span>
                <span class="info-value">{{ cita.mascota }}</span>
            </div>
            <div class="info-row">
                <span class="info-label">Tipo:</span>
                <span class="info-value">{{ cita.tipo_mascota }}</span>
            </div>
            <div class="info-row">
                <span class="info-label">Servicio:</span>
                <span class="info-value">{{ cita.get_tipo_servicio_display }}</span>
            </div>
        </div>

        <div class="info-section">
            <h3> Información de la Cita</h3>
            <div class="info-row">
                <span class="info-label">Fecha:</span>
                <span class="info-value" id="fechaCitaDisplay">{{ cita.fecha_cita }}</span>
            </div>
            <div class="info-row">
                <span class="info-label">Hora:</span>
                <span class="info-value">{{ cita.hora_cita }}</span>
            </div>
            <div class="info-row">
                <span class="info-label">Agendada el:</span>
                <span class="info-value">{{ cita.creado_en|date:"d/m/Y H:i" }}</span>
            </div>
        </div>

        <div class="info-section">
            <h3> Motivo de la Consulta</h3>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; border-left: 4px solid #3498db; margin-top: 10px;">
                {{ cita.descripcion|linebreaks }}
            </div>
        </div>

        <div class="info-section">
            <h3> Información de Contacto</h3>
            <div class="info-row">
                <span class="info-label">Propietario:</span>
                <span class="info-value">{{ cita.propietario.get_full_name|default:cita.propietario.username }}</span>
            </div>
            <div class="info-row">
                <span class="info-label">Teléfono:</span>
                <span class="info-value">{{ cita.telefono }}</span>
            </div>
            <div class="info-row">
                <span class="info-label">Email:</span>
                <span class="info-value">{{ cita.email }}</span>
            </div>
        </div>

        <div style="margin-top: 30px; display: flex; gap: 10px; flex-wrap: wrap;">
            <a href="{% url 'citas:editar_cita' cita.pk %}" class="btn"> Editar Cita</a>
            <a href="{% url 'citas:eliminar_cita' cita.pk %}" class="btn btn-danger"> Cancelar Cita</a>
            <a href="{% url 'citas:lista_citas' %}" class="btn"> Volver a la Lista</a>
        </div>
    </div>

    <!-- Columna derecha: Calendario -->
    <div class="calendar-sidebar">
        <div class="calendar-header">
            <button class="calendar-nav" onclick="changeMonth(-1)">‹</button>
            <div class="calendar-month-year">
                <h3 class="calendar-month" id="currentMonth"></h3>
                <p class="calendar-year" id="currentYear"></p>
            </div>
            <button class="calendar-nav" onclick="changeMonth(1)">›</button>
        </div>
        
        <div class="calendar">
            <div class="calendar-grid" id="calendarGrid">
                <!-- Los días se generan dinámicamente con JavaScript -->
            </div>
        </div>
        
        <div class="cita-date-highlight">
            <div class="fecha" id="citaFechaFormateada"></div>
            <div class="hora">Hora: {{ cita.hora_cita }}</div>
        </div>
    </div>
</div>

<script>
// SOLUCIÓN DEFINITIVA: Parsear la fecha manualmente desde el string de Django
function parseDjangoDate(dateString) {
    // Django devuelve la fecha en formato: '2025-12-11'
    const parts = dateString.split('-');
    const year = parseInt(parts[0]);
    const month = parseInt(parts[1]) - 1; // Los meses en JavaScript van de 0 a 11
    const day = parseInt(parts[2]);
    
    // Crear fecha sin problemas de zona horaria
    return new Date(year, month, day, 12, 0, 0, 0); // Hora fija a mediodía
}

// Variables globales
let currentDate = new Date();
let citaDate = parseDjangoDate('{{ cita.fecha_cita|date:"Y-m-d" }}');

// Nombres de meses en español
const monthNames = [
    'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
    'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
];

// Nombres de días en español
const dayNames = ['Do', 'Lu', 'Ma', 'Mi', 'Ju', 'Vi', 'Sá'];

// Nombres completos de días para mostrar la fecha
const fullDayNames = [
    'Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'
];

// Formatear fecha en español
function formatDate(date) {
    const day = fullDayNames[date.getDay()];
    const dayNumber = date.getDate();
    const month = monthNames[date.getMonth()];
    const year = date.getFullYear();
    return `${day}, ${dayNumber} de ${month} de ${year}`;
}

// Función para comparar fechas ignorando la hora
function isSameDate(date1, date2) {
    return date1.getFullYear() === date2.getFullYear() &&
           date1.getMonth() === date2.getMonth() &&
           date1.getDate() === date2.getDate();
}

// Generar calendario
function generateCalendar() {
    const calendarGrid = document.getElementById('calendarGrid');
    const currentMonthElement = document.getElementById('currentMonth');
    const currentYearElement = document.getElementById('currentYear');
    const citaFechaElement = document.getElementById('citaFechaFormateada');
    const fechaCitaDisplay = document.getElementById('fechaCitaDisplay');
    
    // Actualizar encabezado
    currentMonthElement.textContent = monthNames[currentDate.getMonth()];
    currentYearElement.textContent = currentDate.getFullYear();
    
    // Actualizar fecha formateada de la cita
    citaFechaElement.textContent = formatDate(citaDate);
    
    // También actualizar la fecha en la información principal
    fechaCitaDisplay.textContent = formatDate(citaDate);
    
    // Limpiar calendario
    calendarGrid.innerHTML = '';
    
    // Agregar días de la semana
    dayNames.forEach(day => {
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-weekday';
        dayElement.textContent = day;
        calendarGrid.appendChild(dayElement);
    });
    
    // Obtener primer día del mes y último día del mes
    const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
    const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
    const today = new Date();
    today.setHours(12, 0, 0, 0); // Normalizar hora para comparación
    
    // Días vacíos al inicio
    const startingDay = firstDay.getDay();
    for (let i = 0; i < startingDay; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'calendar-day empty';
        calendarGrid.appendChild(emptyDay);
    }
    
    // Días del mes
    for (let day = 1; day <= lastDay.getDate(); day++) {
        const dayElement = document.createElement('div');
        const currentDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
        currentDay.setHours(12, 0, 0, 0); // Normalizar hora para comparación
        
        // Determinar clase del día
        let dayClass = 'calendar-day normal';
        
        // Verificar si es hoy
        if (isSameDate(currentDay, today)) {
            dayClass = 'calendar-day today';
        }
        
        // Verificar si es el día de la cita
        if (isSameDate(currentDay, citaDate)) {
            dayClass = 'calendar-day cita-day';
        }
        
        dayElement.className = dayClass;
        dayElement.textContent = day;
        
        calendarGrid.appendChild(dayElement);
    }
}

// Cambiar mes
function changeMonth(direction) {
    currentDate.setMonth(currentDate.getMonth() + direction);
    generateCalendar();
}

// Inicializar calendario cuando se carga la página
document.addEventListener('DOMContentLoaded', function() {
    // Establecer la fecha actual al mes de la cita
    currentDate = new Date(citaDate);
    generateCalendar();
    
    // Debug: mostrar información de fechas en consola
    console.log('Fecha de la cita (original):', '{{ cita.fecha_cita|date:"Y-m-d" }}');
    console.log('Fecha de la cita (parseada):', citaDate);
    console.log('Día de la cita:', citaDate.getDate());
    console.log('Mes de la cita:', citaDate.getMonth() + 1); // +1 porque los meses van de 0-11
    console.log('Año de la cita:', citaDate.getFullYear());
});
</script>
{% endblock %}